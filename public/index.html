<!DOCTYPE html>
<html>
<head>
  <title>birds</title>
  <style type="text/css">
    body{font-family: sans-serif}
    /*input{display: block}*/
    #map {
      height: 500px; 
      width: 500px; 
      margin-bottom: 30px;
    }
    [type=submit]{
      display: block;
      margin:3em 0;
    }
  </style>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">

   <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />

</head>
<body>
  <h1>birds</h1>
  <form method="post">

    <div id="map"></div>
    
    <label>
      lat min
      <input name="lat_min" id="lat_min" value="51.75" size="5">
    </label>
    
    <label>
      lon min
      <input name="lon_min" id="lon_min" value="1.25" size="5">
    </label>
    
    <label>
      lat max
      <input name="lat_max" id="lat_max" value="52.75" size="5">
    </label>
    
    <label>
      lon max
      <input name="lon_max" id="lon_max" value="2.25" size="5">
    </label>

    <input type="submit">
  </form>

  <ol id="results">
  </ol>




   <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
   <style type="text/css"> </style>
   <script type="text/javascript">
    var map = L.map('map').setView([51.75, -1.25], 9);

    // L.mapbox.accessToken = 'pk.eyJ1IjoiYmVuamFtaW5iZW5iZW4iLCJhIjoiT3I1N1hMUSJ9.69a8Y_2A8x122liNhTQe-Q';
    
    L.tileLayer('http://api.tiles.mapbox.com/v4/benjaminbenben.fb16caf5/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYmVuamFtaW5iZW5iZW4iLCJhIjoiT3I1N1hMUSJ9.69a8Y_2A8x122liNhTQe-Q', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18
    }).addTo(map);

    function populate(){
      var bounds = map.getBounds();
      lat_min.value = bounds._southWest.lat;
      lon_min.value = bounds._southWest.lng;
      lat_max.value = bounds._northEast.lat;
      lon_max.value = bounds._northEast.lng;
    }

    populate();
    map.on('move', populate);

    var markers = [];


    var form = document.querySelector('form');
    form.onsubmit = request;

    function request(e){
      e.preventDefault();
      var formData = new FormData(form);

      var req = new XMLHttpRequest();
      req.open("POST", "/");
      req.onload = function() {
        if (req.status == 200) {
          // 
          // oOutput.innerHTML = "Uploaded!";

          var response = JSON.parse(req.responseText);

          var l = markers.length;
          markers.forEach(function(m, i){
            setTimeout(function(){
              map.removeLayer(m);
            }, i * (500 / l));
          });

          markers = [];

          var r = response.recordings.length;
          response.recordings.forEach(function(r, i){
            var marker = L.marker([r.lat, r.lng])
                          .bindPopup(r.en)
                          .addTo(map);

            markers.push(marker);
          });


        } else {
          console.log("Error " + req.status);
        }
      };
      req.send(formData);
    }


   </script>




  <hr />


</body>
</html>